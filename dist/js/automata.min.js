"use strict";export default class Automata{constructor(e={attribute:"data-tasks",json_file:"tasks.json",start_element:"body"}){this.triggers=new Set(["click","init","mouseenter","mouseover","mouseup","mouseleave","scroll","scrollend","submit"]);this.methods=new Set(["get","post","put","patch","delete"]);this.dataAttribute=e["attribute"];this.jsonFile=e["json_file"];this.startElement=e["start_element"];this.tasks={}}fetchOptions(e,t){let r={method:e.method,cache:"no-cache"};if(["post","put","patch"].includes(e.method)){r["headers"]={"Content-Type":"application/json"};r["body"]=JSON.stringify(t);return r}return r}async makeRequest(t,r={}){console.log("Body Data:",r,t.action);try{const s=await fetch(t.action,this.fetchOptions(t,r));if(!s.ok){throw new Error(`HTTP error! status: ${s.status} ${s.statusText}`)}let e={transformation:{},data:undefined};if(s.headers.has("Automata-Transformation")){console.log("Automata-Transformation:",s.headers.get("Automata-Transformation"));const a=s.headers.get("Automata-Transformation");if(a!==""){e.transformation=this.attrsStr2Obj(a)}}if(s.headers.has("Content-Type")){if(s.headers.get("Content-Type").includes("application/json")){const n=await s.json();e.data=n;return e}}const o=await s.text();e.data=o;return e}catch(e){console.error(e)}}attrsStr2Obj(e){if(e===""){return{}}const t=e.replace(/[\r\n] */gm,"").replace(/\;$/,"").split(/\; */);let r={};for(const s of t){const o=s.split(/\: */);if(o.length!=2){throw new Error(`Wrong data atribute: ${s}`)}r[o[0]]=o[1]}return r}async getResource(e){if(e.length<=".json".length||!e.endsWith(".json")){throw new Error(`The ${e} file is not a valid JSON file!`)}const t=await fetch(e,{cache:"no-cache"});if(!t.ok){throw new Error(`When fetching the file ${e} \
                happen an HTTP error! status: ${t.status} ${t.statusText}`)}return await t.json()}swapContent(e,t,r="inner"){if(r==="inner"){t.replaceChildren(...e.childNodes);return}if(r==="outer"){t.replaceWith(...e.childNodes);return}if(r==="before"){t.before(...e.childNodes)}if(r==="after"){t.after(...e.childNodes);return}if(r==="prepend"){t.prepend(...e.childNodes);return}if(r==="append"){t.append(...e.childNodes);return}if(r==="delete"){t.remove();return}if(r==="none"){return}throw new Error(`swap "${r}" attribute not supported`)}addKeyValue(e,t,r,s=false){if(e.hasOwnProperty(t)){if(Array.isArray(e[t])){e[t].push(r)}else{const o=e[t];e[t]=[];e[t].push(o,r)}}else{if(s){e[t]=[];e[t].push(r)}else{e[t]=r}}}collectBodyData(e,t,r=""){if(e.hasChildNodes()){if(e.hasAttribute("name")){if(e.hasAttribute("name")&&!e.hasAttribute("value")){t[e.name]=[];r=e.name}}for(const s of e.childNodes){if(s.nodeType!==Node.TEXT_NODE){this.collectBodyData(s,t,r)}}}if(e.nodeType!==Node.TEXT_NODE){if(e.hasAttribute("value")){if(e.hasAttribute("name")){if(e.hasAttribute("type")&&e.type.toLowerCase()==="radio"){if(e.checked){this.addKeyValue(t,e.name,e.value)}}else if(e.type.toLowerCase()==="checkbox"){if(e.checked){this.addKeyValue(t,e.name,e.value,true)}}else{this.addKeyValue(t,e.name,e.value)}}else{if(e.nodeName==="OPTION"&&e.selected){const o=e.closest("select");if(o.hasChildNodes()){this.addKeyValue(t,o.name,e.value,true)}}}}}}search4Tasks(e){if(e.hasChildNodes()){for(const t of e.childNodes){if(t.nodeName!=="TEMPLATE"&&t.nodeName!=="SCRIPT"&&t.nodeType!==t.TEXT_NODE&&t.nodeType!==t.COMMENT_NODE&&t.nodeType!==t.DOCUMENT_FRAGMENT_NODE){if(t.hasAttribute(this.dataAttribute)){this.setTask(t)}if(t.hasChildNodes()){this.search4Tasks(t)}}}}}minifyJavaScript(e){return e.replace(/\/\/.*|\/\*[\s\S]*?\*\//g,"").replace(/\s+/g," ").trim()}reScript(e){for(const t of e.childNodes){if(t.hasChildNodes()){this.reScript(t)}if(t.nodeName==="SCRIPT"){const r=document.createElement("script");r.type="text/javascript";r.textContent=this.minifyJavaScript(t.textContent);t.replaceWith(r)}}}buildFragment(data,source){const helper=document.createElement("div");helper.innerHTML=eval("`"+source+"`");this.reScript(helper);return helper}async fetchTemplate(e){try{const t=await fetch("./templates/".concat(e,".html"));if(!t.ok){throw new Error(`HTTP error! status: ${t.status} ${t.statusText}`)}return t.text()}catch(e){console.error(e)}return undefined}setTransformation(e,t){if(t.hasOwnProperty("target")){e["target"]=t["target"]}else if(!e.hasOwnProperty("target")){e["target"]="this"}if(t.hasOwnProperty("template")){e["template"]=t["template"]}if(t.hasOwnProperty("swap")){e["swap"]=t["swap"]}else if(!e.hasOwnProperty("swap")){e["swap"]="inner"}if(t.hasOwnProperty("remove")){e["remove"]=t["remove"]}}async templateManager(e,r,t){if(r.template.length<3){throw new Error(`Short template name "${r.template}"`)}const s=await async function(e){switch(Array.from(r.template)[0]){case"@":return await e.fetchTemplate(r.template.substring(1));case"#":const t=document.getElementById(r.template.substring(1));if(t===null){throw new Error(`Template "${r.template}" not exist!`)}if(t.content.hasChildNodes()&&t.content.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&t.content.children[0].nodeName==="TEXTAREA"&&t.content.children[0].hasAttribute("data-codeblock")){return t.content.children[0].value}throw new Error(`Invalid "${r.template}" embedded template`);default:throw new Error(`Invalid "${r.template}" fetched template`)}}(this);const o=this.buildFragment(t,s);if(o===null){throw new Error(`An error happened while processing the "${r.template}" template`)}if(r.hasOwnProperty("remove")&&r.remove!==""){const a=document.querySelectorAll(r.remove);for(const n of a){n.remove()}}this.search4Tasks(o);this.swapContent(o,e,r.swap)}async processEvent(e,t){for(const a of["action","method","remove","src-file","swap","target"]){const n="attribute-".concat(a);if(t.hasOwnProperty(n)&&e.hasAttribute(t[n])&&e.getAttribute(t[n])!==""){t[a]=e.getAttribute(t[n])}}if(!(t.hasOwnProperty("action")&&t.hasOwnProperty("method"))){const o=t.target==="this"?e:document.querySelector(t.target);if(o===null){throw new Error(`Template "${t.target}" not exist!`)}if(t.hasOwnProperty("template")){const i=await async function(e){if(t.hasOwnProperty("src-file")){return await e.getResource(t["src-file"])}return{}}(this);this.templateManager(o,t,i)}return}let r={};if(t.trigger==="submit"){const c=e.closest("form");if(c!==null&&c.hasChildNodes()){const h=c.querySelectorAll("input[name],select[name]");for(const l of h){this.collectBodyData(l,r)}}}else if(t.hasOwnProperty("collect-data")){const d=document.querySelectorAll(t["collect-data"]);for(const f of d){this.collectBodyData(f,r)}if(["post","put"].includes(t["method"])&&Object.keys(r).length===0){return}if(e.name!==""){r[e.name]=e.value}}if(t.hasOwnProperty("method")){t.method=t.method.toLowerCase();if(!this.methods.has(t.method)){throw new Error(`Unknown HTTP method: ${t.method}`)}}else{t["method"]="get"}const s=await this.makeRequest(t,r);if(s===undefined){return}this.setTransformation(t,s.transformation);const o=t.target==="this"?e:document.querySelector(t.target);if(o===null){throw new Error(`Template "${t.target}" not exist!`)}if(typeof s.data==="object"){if(t.hasOwnProperty("template")){this.templateManager(o,t,s.data)}}else if(typeof s.data==="string"&&s.data!==""){const u=function(e){const t=document.createElement("div");t.innerHTML=s.data;e.reScript(t);return t}(this);if(t.hasOwnProperty("remove")&&t.remove!==""){const p=document.querySelectorAll(t.remove);for(const m of p){m.remove()}}this.search4Tasks(u);this.swapContent(u,o,t.swap)}else{throw new Error("There is no data or text for the transformation")}}async setTask(e){const t=e.dataset.tasks.split(/ +/);for(const r of t){if(!this.tasks.hasOwnProperty(r)){throw new Error(`The task "${r}" not exist in tasks file!`)}console.log("Task:",r);const s=this.tasks[r];if(s.hasOwnProperty("attribute-trigger")&&e.hasAttribute(s["attribute-trigger"])&&e.getAttribute(s["attribute-trigger"])!==""){s["trigger"]=e.getAttribute(s["attribute-trigger"])}if(s.trigger==="init"){this.processEvent(e,s);continue}if(!(s.hasOwnProperty("trigger")&&this.triggers.has(s.trigger))&&(e.nodeName==="BUTTON"||e.nodeName==="INPUT"&&e.type==="button")){s.trigger="click"}const o=function(){if(s.trigger==="scroll"||s.trigger==="scrollend"){return document}return e}();o.addEventListener(s.trigger,e=>{e.preventDefault();this.processEvent(e.target,s)})}}init(){const t=document.getElementsByTagName(this.startElement);const e={childList:true,subtree:true};const r=(e,s)=>{e.forEach(e=>{if(e.type==="childList"){for(const t of e.addedNodes){console.log("Added Nodes...")}for(const r of e.removedNodes){console.log("Removed Nodes...")}if(e.target.childNodes.length===0){s.disconnect()}}})};const s=new MutationObserver(r);s.observe(t[0],e);this.getResource(this.jsonFile).then(e=>{this.tasks=e;this.search4Tasks(t[0])})}}export{Automata};