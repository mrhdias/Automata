"use strict";export default class Secutio{constructor(t={tasks_attribute:"data-tasks",tasks_file:"tasks.json",start_element:"body"}){this.triggers=new Set(["click","init","keydown","mouseenter","mouseover","mouseup","mouseleave","scroll","scrollend","submit"]);this.methods=new Set(["get","post","put","patch","delete"]);this.tasksAttribute=t["tasks_attribute"];this.tasksFile=t["tasks_file"];this.startElement=t["start_element"];this.tasks={};this.custom_functions={}}fetchOptions(t,e){let r={method:t.method,cache:"no-cache"};if(["post","put","patch"].includes(t.method)){r["headers"]={"Content-Type":"application/json"};r["body"]=JSON.stringify(e);return r}return r}async makeRequest(e,r={}){console.log("Body Data:",r,e.action);try{const s=await fetch(e.action,this.fetchOptions(e,r));if(!s.ok){throw new Error(`HTTP error! status: ${s.status} ${s.statusText}`)}let t={transformation:{},data:undefined};if(s.headers.has("Secutio-Transformation")){console.log("Secutio-Transformation:",s.headers.get("Secutio-Transformation"));const a=s.headers.get("Secutio-Transformation");if(a!==""){t.transformation=this.attrsStr2Obj(a)}}if(s.headers.has("Content-Type")){if(s.headers.get("Content-Type").includes("application/json")){const n=await s.json();t.data=n;return t}}const o=await s.text();t.data=o;return t}catch(t){console.error(t)}}attrsStr2Obj(t){if(t===""){return{}}const e=t.replace(/[\r\n] */gm,"").replace(/\;$/,"").split(/\; */);let r={};for(const s of e){const o=s.split(/\: */);if(o.length!=2){throw new Error(`Wrong data atribute: ${s}`)}r[o[0]]=o[1]}return r}async getResource(t){if(t.length<=".json".length||!t.endsWith(".json")){throw new Error(`The ${t} file is not a valid JSON file!`)}const e=await fetch(t,{cache:"no-cache"});if(!e.ok){throw new Error(`When fetching the file ${t} \
                happen an HTTP error! status: ${e.status} ${e.statusText}`)}return await e.json()}runNextTask(t,e){if(!this.tasks.hasOwnProperty(e)){throw new Error(`The next task "${e}" not exist in tasks file!`)}const r=this.tasks[e];if(!r.hasOwnProperty("disabled")){r["disabled"]=false}if(r.hasOwnProperty("trigger")){throw new Error(`The trigger property from "${e}" is not allowed in next task!`)}if(r.disabled===false){this.setTemplateData(t,r,undefined)}}runSubtasks(t){const e=t.split(/ +/);for(const r of e){if(!this.tasks.hasOwnProperty(r)){throw new Error(`The subtask "${r}" not exist in tasks file!`)}if(!this.tasks[r].hasOwnProperty("selector")){continue}const s=this.tasks[r];for(const a in s){if(!["selector","remove","add"].includes(a)){throw new Error(`The property "${a}" in subtask "${r}" is not allowed with property "selector"!`)}}if(Object.prototype.toString.call(s)!=="[object Object]"){throw new Error(`The properties of subtask "${r}" is not a object!`)}if(!s.hasOwnProperty("selector")){throw new Error(`The properties of subtask "${r}" not have a selector!`)}const o=document.querySelectorAll(s["selector"]);if(s.hasOwnProperty("remove")&&Object.keys(s["remove"]).length===0){for(const n of o){n.remove()}continue}for(const n of o){if(s.hasOwnProperty("remove")){if(s["remove"].hasOwnProperty("attributes")){if(!Array.isArray(s["remove"]["attributes"])){throw new Error(`The property "remove/attributes" of subtask "${r}" is not an array!`)}for(const i of s["remove"]["attributes"]){if(n.hasAttribute(i)){n.removeAttribute(i);if(i==="class"||i==="style"){return true}}}}if(n.hasAttribute("class")&&s["remove"].hasOwnProperty("class")){if(n.classList.contains(s["remove"]["class"])){n.classList.remove(s["remove"]["class"])}if(n.getAttribute("class")===""){n.removeAttribute("class")}}if(n.hasAttribute("style")&&s["remove"].hasOwnProperty("style")){let t=n.style;const c=s["remove"]["style"].split(/ +/);for(const l of c){if(n.style.hasOwnProperty(l)){delete t[l]}}n.style=t;if(n.getAttribute("style")===""){n.removeAttribute("style")}}}if(s.hasOwnProperty("add")){if(s["add"].hasOwnProperty("attributes")){if(Object.prototype.toString.call(s["add"]["attributes"])!=="[object Object]"){throw new Error(`The properties "add/attributes" of subtask "${r}" is not a object!`)}for(const[i,h]of Object.entries(s["add"]["attributes"])){if(!n.hasAttribute(i)){n.setAttribute(i,h)}}}if(s["add"].hasOwnProperty("class")){n.classList.add(s["add"]["class"])}if(s["add"].hasOwnProperty("style")){if(n.hasAttribute("style")){const c=this.attrsStr2Obj(s["add"]["style"]);for(const[f,h]of Object.entries(c)){n.style[f]=h}}else{n.setAttribute("style",s["add"]["style"])}}}}}}swapContent(t,e,r="inner"){if(r==="inner"){e.replaceChildren(...t.childNodes);return}if(r==="outer"){e.replaceWith(...t.childNodes);return}if(r==="before"){e.before(...t.childNodes)}if(r==="after"){e.after(...t.childNodes);return}if(r==="prepend"){e.prepend(...t.childNodes);return}if(r==="append"){e.append(...t.childNodes);return}if(r==="delete"){e.remove();return}if(r==="none"){return}throw new Error(`swap "${r}" attribute not supported`)}addKeyValue(t,e,r,s=false){if(t.hasOwnProperty(e)){if(Array.isArray(t[e])){t[e].push(r)}else{const o=t[e];t[e]=[];t[e].push(o,r)}}else{if(s){t[e]=[];t[e].push(r)}else{t[e]=r}}}collectBodyData(t,e,r=""){if(t.hasChildNodes()){if(t.hasAttribute("name")){if(!t.hasAttribute("value")){e[t.name]=[];r=t.name}}for(const s of t.childNodes){if(s.nodeType!==Node.TEXT_NODE){this.collectBodyData(s,e,r)}}}if(t.nodeType!==Node.TEXT_NODE){if(t.hasAttribute("value")){if(t.hasAttribute("name")){if(t.hasAttribute("type")&&t.type.toLowerCase()==="radio"){if(t.checked){this.addKeyValue(e,t.name,t.value)}}else if(t.type.toLowerCase()==="checkbox"){if(t.checked){this.addKeyValue(e,t.name,t.value,true)}}else{this.addKeyValue(e,t.name,t.value)}}else{if(t.nodeName==="OPTION"&&t.selected){const o=t.closest("select");if(o.hasChildNodes()){this.addKeyValue(e,o.name,t.value,true)}}}}}}search4Tasks(t){if(t.hasChildNodes()){for(const e of t.childNodes){if(e.nodeName!=="TEMPLATE"&&e.nodeName!=="SCRIPT"&&e.nodeType!==e.TEXT_NODE&&e.nodeType!==e.COMMENT_NODE&&e.nodeType!==e.DOCUMENT_FRAGMENT_NODE){if(e.hasAttribute(this.tasksAttribute)){this.setTask(e)}if(e.hasChildNodes()){this.search4Tasks(e)}}}}}minifyJavaScript(t){return t.replace(/\/\/.*|\/\*[\s\S]*?\*\//g,"").replace(/\s+/g," ").trim()}reScript(t){for(const e of t.childNodes){if(e.hasChildNodes()){this.reScript(e)}if(e.nodeName==="SCRIPT"){const r=document.createElement("script");r.type="text/javascript";r.textContent=this.minifyJavaScript(e.textContent);e.replaceWith(r)}}}buildFragment(input,data,source){const helper=document.createElement("div");helper.innerHTML=eval("`"+source+"`");this.reScript(helper);return helper}async fetchTemplate(t){try{const e=await fetch("./templates/".concat(t,".html"));if(!e.ok){throw new Error(`HTTP error! status: ${e.status} ${e.statusText}`)}return e.text()}catch(t){console.error(t)}return undefined}setTransformation(t,e){if(e.hasOwnProperty("target")){t["target"]=e["target"]}else if(!t.hasOwnProperty("target")){t["target"]="this"}if(e.hasOwnProperty("template")){t["template"]=e["template"]}if(e.hasOwnProperty("swap")){t["swap"]=e["swap"]}else if(!t.hasOwnProperty("swap")){t["swap"]="inner"}if(e.hasOwnProperty("remove")){t["remove"]=e["remove"]}}sequenceTasks(t,e,r){if(r.hasOwnProperty("before")&&r.before!==""){this.runSubtasks(r.before)}this.search4Tasks(t);this.swapContent(t,e,r.swap);if(r.hasOwnProperty("after")&&r.after!==""){this.runSubtasks(r.after)}if(r.hasOwnProperty("next")&&r.next!==""){this.runNextTask(e,r.next)}}thisElement(t,e,r){const s=e.split(/\, */);let o=[];for(const a of s){if(a==="this"){if(t.hasAttribute("name")&&t.name!==""){r[t.name]=t.hasAttribute("value")?t.value:""}continue}o.push(a)}return o.join(",")}async templateManager(t,r,e,s){if(r.template.length<3){throw new Error(`Short template name "${r.template}"`)}const o=await async function(t){switch(Array.from(r.template)[0]){case"@":return await t.fetchTemplate(r.template.substring(1));case"#":const e=document.getElementById(r.template.substring(1));if(e===null){throw new Error(`Template "${r.template}" not exist!`)}if(e.content.hasChildNodes()&&e.content.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&e.content.children[0].nodeName==="TEXTAREA"&&e.content.children[0].hasAttribute("data-codeblock")){return e.content.children[0].value}throw new Error(`Invalid "${r.template}" embedded template`);default:throw new Error(`Invalid "${r.template}" fetched template`)}}(this);const a=this.buildFragment(e,s,o);if(a===null){throw new Error(`An error happened while processing the "${r.template}" template`)}this.sequenceTasks(a,t,r)}setFinalTarget(t,e){if(e==="this"){return t}const r=document.querySelector(e);if(r===null){throw new Error(`Target "${e}" not exist!`)}return r}async setTemplateData(t,e,r){let s={};if(e.hasOwnProperty("collect-data")){const a=this.thisElement(t,e["collect-data"],s);if(a.length>0){const n=document.querySelectorAll(a);for(const i of n){this.collectBodyData(i,s)}}}const o=await async function(t){if(e.hasOwnProperty("src-file")){return await t.getResource(e["src-file"])}return{}}(this);if(e.hasOwnProperty("function")){if(!this.custom_functions.hasOwnProperty(e["function"])){throw new Error(`The registered function "${e.function}" not exist!`)}this.custom_functions[e["function"]](r,s,o)}if(e.hasOwnProperty("template")&&e.hasOwnProperty("target")&&e.target!=""){this.templateManager(this.setFinalTarget(t,e.target),e,s,o)}}async processEvent(t,e){for(const a of["action","method","src-file","swap","target","after","before","next"]){const n="attribute-".concat(a);if(e.hasOwnProperty(n)&&t.target.hasAttribute(e[n])&&t.target.getAttribute(e[n])!==""){e[a]=t.target.getAttribute(e[n])}}if(!(e.hasOwnProperty("action")&&e.hasOwnProperty("method"))){this.setTemplateData(t.target,e,t);return}let r={};if(e.trigger==="submit"){const i=t.target.closest("form");if(i!==null&&i.hasChildNodes()){const c=i.querySelectorAll("input[name],select[name]");for(const l of c){this.collectBodyData(l,r)}}}else if(e.hasOwnProperty("collect-data")){const h=document.querySelectorAll(e["collect-data"]);for(const f of h){this.collectBodyData(f,r)}if(["post","put"].includes(e["method"])&&Object.keys(r).length===0){return}if(t.target.name!==""){r[t.target.name]=t.target.value}}if(e.hasOwnProperty("method")){e.method=e.method.toLowerCase();if(!this.methods.has(e.method)){throw new Error(`Unknown HTTP method: ${e.method}`)}}else{e["method"]="get"}const s=await this.makeRequest(e,r);if(s===undefined){return}this.setTransformation(e,s.transformation);const o=this.setFinalTarget(t.target,e.target);if(typeof s.data==="object"){if(e.hasOwnProperty("template")){this.templateManager(o,e,{},s.data)}}else if(typeof s.data==="string"&&s.data!==""){const d=function(t){const e=document.createElement("div");e.innerHTML=s.data;t.reScript(e);return e}(this);this.sequenceTasks(d,o,e)}else{throw new Error("There is no data or text for the transformation")}}async setTask(t){const e=t.dataset.tasks.split(/ +/);for(const r of e){if(!this.tasks.hasOwnProperty(r)){throw new Error(`The task "${r}" not exist in tasks file!`)}console.log("Task:",r);const s=structuredClone(this.tasks[r]);if(s.hasOwnProperty("attribute-trigger")&&t.hasAttribute(s["attribute-trigger"])&&t.getAttribute(s["attribute-trigger"])!==""){s["trigger"]=t.getAttribute(s["attribute-trigger"])}if(!s.hasOwnProperty("disabled")){s["disabled"]=false}if(s.trigger==="init"){if(s.disabled===false){const a=new CustomEvent("init",{bubbles:true,cancelable:true});let e=this;t.addEventListener("init",function(t){t.preventDefault();if(s.disabled===false){e.processEvent(t,s)}});t.dispatchEvent(a)}continue}if(!(s.hasOwnProperty("trigger")&&this.triggers.has(s.trigger))){s.trigger=function(){if(t.nodeName==="FORM"){return"submit"}if(t.nodeName==="BUTTON"){return t.type==="submit"?"submit":"click"}if(t.nodeName==="INPUT"&&t.type==="button"){return"click"}throw new Error(`No trigger defined for "${r}"!`)}()}const o=function(){if(s.trigger==="scroll"||s.trigger==="scrollend"){return document}return t}();o.addEventListener(s.trigger,t=>{t.preventDefault();if(s.disabled===false){this.processEvent(t,s)}})}}function_register(t,e){this.custom_functions[t]=e}init(){const e=document.getElementsByTagName(this.startElement);const t={childList:true,subtree:true};const r=(t,s)=>{t.forEach(t=>{if(t.type==="childList"){for(const e of t.addedNodes){console.log("Added Nodes...")}for(const r of t.removedNodes){console.log("Removed Nodes...")}if(t.target.childNodes.length===0){s.disconnect()}}})};const s=new MutationObserver(r);s.observe(e[0],t);this.getResource(this.tasksFile).then(t=>{this.tasks=t;this.search4Tasks(e[0])})}}export{Secutio};