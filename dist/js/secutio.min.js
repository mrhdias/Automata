(function(t,e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define(e)}else{t.Secutio=e()}})(this,function(){"use strict";class t{constructor(t={tasks_attribute:"data-tasks",start_element:"body"}){this.triggers=new Set(["change","click","focus","init","input","keydown","mouseenter","mouseover","mouseup","mouseleave","mousemove","reset","scroll","scrollend","submit"]);this.methods=new Set(["get","post","put","patch","delete"]);this.tasksAttribute=t["tasks_attribute"];this.startElement=t["start_element"];this.tasks={};this.callbacks={};this.extensions={}}fetchOptions(t,e){let r={method:t.hasOwnProperty("method")?t.method:"get",cache:"no-cache",signal:AbortSignal.timeout(1e3*(t.hasOwnProperty("timeout")?parseInt(t.timeout,10):300))};if(t.method==="post"&&Object.prototype.toString.call(e)==="[object FormData]"){r["body"]=e;return r}if(["post","put","patch"].includes(t.method)){r["headers"]={"Content-Type":"application/json"};r["body"]=JSON.stringify(e);return r}return r}async makeRequest(e,r){try{const s=await fetch(e.action,this.fetchOptions(e,r));let t={transformation:{},data:undefined,ok:s.ok,status:s.status};if(s.headers.has("Secutio-Transformation")){console.log("Secutio-Transformation:",s.headers.get("Secutio-Transformation"));const n=s.headers.get("Secutio-Transformation");if(n!==""){t.transformation=this.attrsStr2Obj(n)}}if(s.headers.has("Content-Type")){if(s.headers.get("Content-Type").includes("application/json")){const o=await s.json();t.data=o;return t}}const a=await s.text();t.data=a;return t}catch(t){return{transformation:{},data:undefined,ok:false,status:0}}}attrsStr2Obj(t){if(t===""){return{}}const e=t.replace(/[\r\n] */gm,"").replace(/\;$/,"").split(/\; */);let r={};for(const s of e){const a=s.split(/\: */);if(a.length!=2){throw new Error(`Wrong data atribute: ${s}`)}r[a[0]]=a[1]}return r}async getResource(e,r){const t=(()=>{for(const t of r){if(e.length>`.${t}`.length&&e.endsWith(`.${t}`)){return t}}throw new Error(`The ${e} file is not a valid file!`)})();const s=await fetch(e,{cache:"no-cache"});if(!s.ok){console.error(`When fetching the file ${e}`+` happen an HTTP error! status: ${s.status} ${s.statusText}`)}s.fileType=t;return s}swapContent(t,e,r){if(e===null){console.warn("no target to swap");return}if(t===null){if(r==="delete"){e.remove();return}if(r==="clean"){while(e.firstChild){e.removeChild(e.firstChild)}return}if(r==="none"){return}return}if(r==="inner"){e.replaceChildren(...t.childNodes);return}if(r==="outer"){e.replaceWith(...t.childNodes);return}if(r==="before"){e.before(...t.childNodes);return}if(r==="after"){e.after(...t.childNodes);return}if(r==="prepend"){e.prepend(...t.childNodes);return}if(r==="append"){e.append(...t.childNodes);return}throw new Error(`swap "${r}" attribute not supported`)}propertyOverride(t,e){for(const r of Object.keys(e)){if(!r.startsWith("attribute-")){continue}const s=r.substring("attribute-".length);if(s.length>1&&t.hasAttribute(e[r])){e[s]=t.getAttribute(e[r])}}}async runNextTask(t,e){const r=e.split(/ +/);for(const s of r){if(!this.tasks.hasOwnProperty(s)){throw new Error(`The next task "${s}" not exist in tasks file!`)}const a=this.tasks[s];this.propertyOverride(t.event.currentTarget!==null?t.event.currentTarget:t.event.target,a);if(!a.hasOwnProperty("disabled")){a["disabled"]=false}if(a.hasOwnProperty("trigger")){throw new Error(`The trigger property from "${s}" is not allowed in next task!`)}if(a.disabled===false){if(!a.hasOwnProperty("wait")){a.wait=0}setTimeout(async()=>{await this.findResourcePath(t,a);if(a.hasOwnProperty("next")){await this.runNextTask(t,a.next)}},a.wait)}}}runSubtasks(t,e){const r=t.event.currentTarget!==null?t.event.currentTarget:t.event.target;const s=e.split(/ +/);for(const a of s){if(!this.tasks.hasOwnProperty(a)){throw new Error(`The subtask "${a}" not exist in tasks file!`)}const n=this.tasks[a];if(!n.hasOwnProperty("selector")){n["traverse"]="target"}for(const i in n){if(!["scroll-into","traverse","selector","remove","add"].includes(i)){throw new Error(`The property "${i}" in subtask "${a}" `+`is not allowed with property "selector"!`)}}if(Object.prototype.toString.call(n)!=="[object Object]"){throw new Error(`The properties of subtask "${a}" is not a object!`)}const o=(()=>{if(n.hasOwnProperty("traverse")){if(n.traverse==="target"){return[r]}if(n.traverse==="closest"&&n.selector!==""){const t=r.closest(n.selector);return t===null?[]:[t]}}if(n.selector!==""){return document.querySelectorAll(n.selector)}throw new Error(`The properties of subtask "${a}" has a empty selector!`)})();if(n.hasOwnProperty("scroll-into")){if(n.selector[0]!=="#"){throw new Error(`The value of the selector property to scroll-into of the "${a}" `+`subtask must start with the "#" character`)}o[0].scrollIntoView(n["scroll-into"]);continue}if(n.hasOwnProperty("remove")&&Object.keys(n["remove"]).length===0){for(const l of o){l.remove()}continue}for(const l of o){if(n.hasOwnProperty("remove")){if(n["remove"].hasOwnProperty("attributes")){if(!Array.isArray(n["remove"]["attributes"])){throw new Error(`The property "remove/attributes" of subtask "${a}" is not an array!`)}for(const c of n["remove"]["attributes"]){if(l.hasAttribute(c)){l.removeAttribute(c);if(c==="class"||c==="style"){return true}}}}if(l.hasAttribute("class")&&n["remove"].hasOwnProperty("class")){const h=n["remove"]["class"].split(/ +/);for(const f of h){if(l.classList.contains(f)){l.classList.remove(f)}}if(l.getAttribute("class")===""){l.removeAttribute("class")}}if(l.hasAttribute("style")&&n["remove"].hasOwnProperty("style")){let t=l.style;const u=n["remove"]["style"].split(/ +/);for(const p of u){if(l.style.hasOwnProperty(p)){delete t[p]}}l.style=t;if(l.getAttribute("style")===""){l.removeAttribute("style")}}}if(n.hasOwnProperty("add")){if(n["add"].hasOwnProperty("attributes")){if(Object.prototype.toString.call(n["add"]["attributes"])!=="[object Object]"){throw new Error(`The properties "add/attributes" of subtask "${a}" is not a object!`)}for(const[c,d]of Object.entries(n["add"]["attributes"])){if(!l.hasAttribute(c)){l.setAttribute(c,d)}}}if(n["add"].hasOwnProperty("class")){const h=n["add"]["class"].split(/ +/);for(const f of h){l.classList.add(f)}}if(n["add"].hasOwnProperty("style")){if(l.hasAttribute("style")){const u=this.attrsStr2Obj(n["add"]["style"]);for(const[m,d]of Object.entries(u)){l.style[m]=d}}else{l.setAttribute("style",n["add"]["style"])}}}}}}async findElemWithTasks(t){if(t.hasChildNodes()){for(const e of t.childNodes){if(e.nodeName!=="TEMPLATE"&&e.nodeName!=="SCRIPT"&&e.nodeType!==e.TEXT_NODE&&e.nodeType!==e.COMMENT_NODE&&e.nodeType!==e.DOCUMENT_FRAGMENT_NODE){if(e.hasChildNodes()){await this.findElemWithTasks(e)}if(e.hasAttribute(this.tasksAttribute)){await this.setTask(e)}}}}}minifyJavaScript(t){return t.replace(/\/\/.*|\/\*[\s\S]*?\*\//g,"").replace(/\s+/g," ").trim()}reScript(t){for(const e of t.childNodes){if(e.hasChildNodes()){this.reScript(e)}if(e.nodeName==="SCRIPT"){const r=document.createElement("script");r.type="text/javascript";r.textContent=this.minifyJavaScript(e.textContent);e.replaceWith(r)}}}buildFragment(s){const t=document.createElement("div");try{if(!s.hasOwnProperty("template")){throw new Error(`The template not exist`)}t.insertAdjacentHTML("afterbegin",(()=>{const t=document.createElement("script");t.type="text/javascript";t.id="temporary-helper";t.innerHTML="function populateTemplate(task) {const data = task.result; return `"+s.template+"`;}";let e=0;let r=setInterval(()=>{if(e>5||document.getElementById("temporary-helper")===null){clearInterval(r);if(e>5){throw new Error(`The temporary helper already exist after 500ms!`)}}e++},100);document.body.appendChild(t);return populateTemplate(s)})());delete s.template;const e=document.getElementById("temporary-helper");if(e!==null){e.remove()}}catch(t){console.error(t)}this.reScript(t);return t}async fetchTemplate(t){try{const e=await fetch(t);if(!e.ok){throw new Error(`HTTP error! status: ${e.status} ${e.statusText}`)}return e.text()}catch(t){console.error(t)}return undefined}setTransformation(t,e){for(const[r,s]of Object.entries({target:"this",template:"",swap:"inner",after:"",before:"","is-template":false})){if(e.hasOwnProperty(r)){t[r]=e[r]}else if(s!==""&&!t.hasOwnProperty(r)){t[r]=s}}}async sequenceTasks(t,e,r){if(r.hasOwnProperty("before")&&r.before!==""){this.runSubtasks(e,r.before)}await this.findElemWithTasks(t);const s=r.target==="this"?e.event.currentTarget:document.querySelector(r.target);this.swapContent(t,s,r.hasOwnProperty("swap")?r.swap:"inner");if(r.hasOwnProperty("after")&&r.after!==""){this.runSubtasks(e,r.after)}}async templateManager(t,r){if(r.template.length<3){throw new Error(`Short template name "${r.template}"`)}t.template=await(async t=>{if(Array.from(r.template)[0]==="#"){const e=document.getElementById(r.template.substring(1));if(e===null){throw new Error(`Embedded template "${r.template}" not exist`)}if(e.nodeName==="SCRIPT"&&e.type.toLowerCase()==="text/template"&&e.hasChildNodes()){return e.textContent}throw new Error(`Invalid "${r.template}" embedded template`)}else{return t.fetchTemplate(r.template)}})(this);const e=this.buildFragment(t);if(e===null){throw new Error(`An error happened while processing the "${r.template}" template`)}return e}async setTemplateData(s,a){s.result=await(async t=>{if(a.hasOwnProperty("src-data")){if(Array.from(a["src-data"])[0]==="#"){const e=document.getElementById(a["src-data"].substring(1));if(e===null){throw new Error(`Source data "${a["src-data"]}" not exist!`)}if(e.DOCUMENT_TYPE_NODE===Node.DOCUMENT_TYPE_NODE&&e.nodeName==="SCRIPT"&&e.type==="application/json"){return JSON.parse(e.textContent)}throw new Error(`Invalid "${a["src-data"]}" embedded source data`)}else{const r=await t.getResource(a["src-data"],["json","txt"]);s.ok=r.ok;s.status=r.status;return!r.ok?r.statusText:r.fileType==="json"?r.json():r.text()}}return s.result||={}})(this);if(a.hasOwnProperty("callback")){if(!this.callbacks.hasOwnProperty(a.callback)){throw new Error(`The registered calback "${a.callback}" not exist!`)}this.callbacks[a.callback](s)}if(a.hasOwnProperty("template")&&a.template!=""&&a.hasOwnProperty("target")&&a.target!=""){const t=await this.templateManager(s,a);await this.sequenceTasks(t,s,a)}else{const e=a.target==="this"?s.event.currentTarget:document.querySelector(a.target);if(e!==null){this.swapContent((()=>{if(typeof s.result==="string"){const t=document.createElement("span");const e=document.createTextNode(s.result);t.append(e);return t}return null})(),e,a.hasOwnProperty("swap")?a.swap:"inner")}}}async processReqData(r,t){if(r.hasOwnProperty("template")){const e=this.buildFragment(r);if(e===null){throw new Error('An error happened while processing the "remote" template from server')}return e}if(!r.hasOwnProperty("result")){throw new Error("There is no any data for the transformation")}if(typeof r.result==="object"){if(t.hasOwnProperty("template")&&t.template!==""){const e=await this.templateManager(r,t);return e}throw new Error("There is no json data for the transformation")}if(typeof r.result==="string"){if(t.hasOwnProperty("template")&&t.template!==""){const e=await this.templateManager(r,t);return e}const e=(t=>{const e=document.createElement("div");e.innerHTML=r.result;t.reScript(e);return e})(this);return e}throw new Error("There is no data for the transformation")}serialize(t){let e={};for(const[r,s]of t){if(e[r]!==undefined){if(!Array.isArray(e[r])){e[r]=[e[r]]}e[r].push(s)}else{e[r]=s}}return e}async prepareRequest(t,e){let r=undefined;if(e.hasOwnProperty("callback")){if(!this.callbacks.hasOwnProperty(e.callback)){throw new Error(`The registered callback "${e.callback}" not exist!`)}const n=this.callbacks[e.callback](t);if(n===false){if(e.hasOwnProperty("next")){delete e.next}return}r=t.data}else if(e.hasOwnProperty("trigger")&&e.trigger==="submit"){const o=t.event.currentTarget.closest("form");if(o!==null){const i=new FormData(o);r=e.method==="post"?i:this.serialize(i)}}const s=await this.makeRequest(e,r);t.ok=s.ok;t.status=s.status;if(e.hasOwnProperty("error")&&!s.ok){e=this.tasks[e["error"]];if(e.hasOwnProperty("message")){s.data=e["message"]}}this.setTransformation(e,s.transformation);if(e["is-template"]==true){t.template=s.data}else{t.result=s.data}const a=await this.processReqData(t,e);await this.sequenceTasks(a,t,e)}async findResourcePath(t,e){if(e.hasOwnProperty("then")&&e.then!==""){this.runSubtasks(t,e.then)}if(e.hasOwnProperty("extension")){if(!e["extension"].hasOwnProperty("name")){throw new Error('The registered extension has no "name" property!')}if(this.extensions.hasOwnProperty(e["extension"]["name"])){if(!this.extensions.hasOwnProperty(e["extension"]["name"])){throw new Error(`The registered extension "${e["extension"]["name"]}" not exist!`)}this.extensions[e["extension"]["name"]](t,e);return}}if(e.hasOwnProperty("action")){if(e.action===""){throw new Error("Empty action")}if(e.hasOwnProperty("method")){e.method=e.method.toLowerCase();if(!this.methods.has(e.method)){throw new Error(`Unknown HTTP method: ${e.method}`)}}else{e["method"]="get"}await this.prepareRequest(t,e);return}await this.setTemplateData(t,e)}async processEvent(t,e){this.propertyOverride(t.event.currentTarget,e);await this.findResourcePath(t,e);if(e.hasOwnProperty("next")&&e.next!==""){await this.runNextTask(t,e.next)}}setDefaultTrigger(t){if(t.nodeName==="FORM"){return"submit"}if(t.nodeName==="BUTTON"){return t.type==="submit"?"submit":"click"}if(t.nodeName==="INPUT"&&t.type==="button"){return"click"}return null}async setTask(t){const e=t.dataset.tasks.split(/ +/);for(const r of e){if(!this.tasks.hasOwnProperty(r)){throw new Error(`The task "${r}" not exist in tasks file!`)}const s=structuredClone(this.tasks[r]);if(s.hasOwnProperty("attribute-trigger")&&t.hasAttribute(s["attribute-trigger"])&&t.getAttribute(s["attribute-trigger"])!==""){s["trigger"]=t.getAttribute(s["attribute-trigger"])}if(!s.hasOwnProperty("disabled")){s["disabled"]=false}if(!s.hasOwnProperty("prevent")){s["prevent"]=true}if(s.trigger==="init"){if(s.disabled===false){t.addEventListener("init",async t=>{if(s.prevent){t.preventDefault()}if(s.disabled===false){try{await this.processEvent({event:t},s)}catch(t){console.log(`Error for "${r}": ${t}`)}}});const a=new CustomEvent("init",{bubbles:true,cancelable:true});t.dispatchEvent(a)}continue}if(s.hasOwnProperty("trigger")){if(!this.triggers.has(s.trigger)){throw new Error(`The "${s.trigger}" trigger is not allowed yet!`)}}else{s.trigger=this.setDefaultTrigger(t);if(s.trigger===null){throw new Error(`No trigger defined for "${r}"!`)}}t.addEventListener(s.trigger,async t=>{if(s.prevent){t.preventDefault()}if(s.disabled===false){try{await this.processEvent({event:t},s)}catch(t){console.log(`Error for "${r}": ${t}`)}}})}}async getDataTasks(){const t=document.querySelectorAll("script[data-tasktable]");for(const e of t){if(e.type.toLowerCase()!=="application/json"){throw new Error(`Wrong mime-type "${e.type}" for element tasks!`)}if(e.hasAttribute("src")&&e.src!==""){const r=await(await this.getResource(e.src,["json"])).json();Object.assign(this.tasks,r);continue}const r=JSON.parse(e.text);Object.assign(this.tasks,r)}}callback_register(t,e){this.callbacks[t]=e}extension_register(t,e){this.extensions[t]=e}init(){const t=document.getElementsByTagName(this.startElement);this.getDataTasks().then(async()=>{if(Object.keys(this.tasks).length>=0){await this.findElemWithTasks(t[0])}})}}return t});