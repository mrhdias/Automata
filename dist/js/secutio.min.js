"use strict";export default class Secutio{constructor(t={tasks_attribute:"data-tasks",start_element:"body"}){this.triggers=new Set(["change","click","focus","init","keydown","mouseenter","mouseover","mouseup","mouseleave","mousemove","scroll","scrollend","submit"]);this.methods=new Set(["get","post","put","patch","delete"]);this.tasksAttribute=t["tasks_attribute"];this.startElement=t["start_element"];this.tasks={};this.custom_functions={}}fetchOptions(t,e){let r={method:t.method,cache:"no-cache",signal:AbortSignal.timeout(1e3*(t.hasOwnProperty("timeout")?parseInt(t.timeout,10):300))};if(t.method==="post"&&Object.prototype.toString.call(e)==="[object FormData]"){r["body"]=e;return r}if(["post","put","patch"].includes(t.method)){r["headers"]={"Content-Type":"application/json"};r["body"]=JSON.stringify(e);return r}return r}async makeRequest(e,r){console.log("Body Data:",r,e.action);try{const s=await fetch(e.action,this.fetchOptions(e,r));if(!s.ok){throw new Error(`HTTP error! status: ${s.status} ${s.statusText}`)}let t={transformation:{},data:undefined,error:false};if(s.headers.has("Secutio-Transformation")){console.log("Secutio-Transformation:",s.headers.get("Secutio-Transformation"));const a=s.headers.get("Secutio-Transformation");if(a!==""){t.transformation=this.attrsStr2Obj(a)}}if(s.headers.has("Content-Type")){if(s.headers.get("Content-Type").includes("application/json")){const n=await s.json();t.data=n;return t}}const o=await s.text();t.data=o;return t}catch(t){if(e.hasOwnProperty("error")){return{transformation:{},data:`${t.name}: ${t.message}`,error:true}}}}attrsStr2Obj(t){if(t===""){return{}}const e=t.replace(/[\r\n] */gm,"").replace(/\;$/,"").split(/\; */);let r={};for(const s of e){const o=s.split(/\: */);if(o.length!=2){throw new Error(`Wrong data atribute: ${s}`)}r[o[0]]=o[1]}return r}async getResource(t,e=false){if(t.length<=".json".length||!t.endsWith(".json")){throw new Error(`The ${t} file is not a valid JSON file!`)}const r=await fetch(t,{cache:"no-cache"});if(!r.ok){if(r.status===404&&e){return{}}throw new Error(`When fetching the file ${t} \
                happen an HTTP error! status: ${r.status} ${r.statusText}`)}return await r.json()}swapContent(t,e,r){if(t===null){if(r==="delete"){e.remove();return}if(r==="none"){return}return}if(r==="inner"){e.replaceChildren(...t.childNodes);return}if(r==="outer"){e.replaceWith(...t.childNodes);return}if(r==="before"){e.before(...t.childNodes);return}if(r==="after"){e.after(...t.childNodes);return}if(r==="prepend"){e.prepend(...t.childNodes);return}if(r==="append"){e.append(...t.childNodes);return}throw new Error(`swap "${r}" attribute not supported`)}async runNextTask(t,e){const r=e.split(/ +/);for(const s of r){if(!this.tasks.hasOwnProperty(s)){throw new Error(`The next task "${s}" not exist in tasks file!`)}const o=this.tasks[s];if(!o.hasOwnProperty("disabled")){o["disabled"]=false}if(o.hasOwnProperty("trigger")){throw new Error(`The trigger property from "${s}" is not allowed in next task!`)}if(o.disabled===false){if(!o.hasOwnProperty("wait")){o.wait=0}setTimeout(async()=>{await this.setTemplateData(t,o)},o.wait)}}}runSubtasks(t,e){const r=e.split(/ +/);for(const s of r){if(!this.tasks.hasOwnProperty(s)){throw new Error(`The subtask "${s}" not exist in tasks file!`)}const o=this.tasks[s];if(!o.hasOwnProperty("selector")){o["traverse"]="target"}for(const n in o){if(!["traverse","selector","remove","add"].includes(n)){throw new Error(`The property "${n}" in subtask "${s}" is not allowed with property "selector"!`)}}if(Object.prototype.toString.call(o)!=="[object Object]"){throw new Error(`The properties of subtask "${s}" is not a object!`)}const a=(()=>{if(o.hasOwnProperty("traverse")){if(o.traverse==="target"){return[t]}if(o.traverse==="closest"&&o["selector"]!==""){return t.closest(o["selector"])}}if(o["selector"]!==""){return document.querySelectorAll(o["selector"])}throw new Error(`The properties of subtask "${s}" has a empty selector!`)})();if(o.hasOwnProperty("remove")&&Object.keys(o["remove"]).length===0){for(const i of a){i.remove()}continue}for(const i of a){if(o.hasOwnProperty("remove")){if(o["remove"].hasOwnProperty("attributes")){if(!Array.isArray(o["remove"]["attributes"])){throw new Error(`The property "remove/attributes" of subtask "${s}" is not an array!`)}for(const c of o["remove"]["attributes"]){if(i.hasAttribute(c)){i.removeAttribute(c);if(c==="class"||c==="style"){return true}}}}if(i.hasAttribute("class")&&o["remove"].hasOwnProperty("class")){if(i.classList.contains(o["remove"]["class"])){i.classList.remove(o["remove"]["class"])}if(i.getAttribute("class")===""){i.removeAttribute("class")}}if(i.hasAttribute("style")&&o["remove"].hasOwnProperty("style")){let t=i.style;const l=o["remove"]["style"].split(/ +/);for(const h of l){if(i.style.hasOwnProperty(h)){delete t[h]}}i.style=t;if(i.getAttribute("style")===""){i.removeAttribute("style")}}}if(o.hasOwnProperty("add")){if(o["add"].hasOwnProperty("attributes")){if(Object.prototype.toString.call(o["add"]["attributes"])!=="[object Object]"){throw new Error(`The properties "add/attributes" of subtask "${s}" is not a object!`)}for(const[c,f]of Object.entries(o["add"]["attributes"])){if(!i.hasAttribute(c)){i.setAttribute(c,f)}}}if(o["add"].hasOwnProperty("class")){i.classList.add(o["add"]["class"])}if(o["add"].hasOwnProperty("style")){if(i.hasAttribute("style")){const l=this.attrsStr2Obj(o["add"]["style"]);for(const[u,f]of Object.entries(l)){i.style[u]=f}}else{i.setAttribute("style",o["add"]["style"])}}}}}}addKeyValue(t,e,r,s=false){if(t.hasOwnProperty(e)){if(Array.isArray(t[e])){t[e].push(r)}else{const o=t[e];t[e]=[];t[e].push(o,r)}}else{if(s){t[e]=[];t[e].push(r)}else{t[e]=r}}}collectBodyData(t,e,r=""){if(t.hasChildNodes()){if(t.hasAttribute("name")){if(!t.hasAttribute("value")){e[t.name]=[];r=t.name}}for(const s of t.childNodes){if(s.nodeType!==Node.TEXT_NODE){this.collectBodyData(s,e,r)}}}if(t.nodeType!==Node.TEXT_NODE){if(t.hasAttribute("value")){if(t.hasAttribute("name")){if(t.hasAttribute("type")&&t.type.toLowerCase()==="radio"){if(t.checked){this.addKeyValue(e,t.name,t.value)}}else if(t.type.toLowerCase()==="checkbox"){if(t.checked){this.addKeyValue(e,t.name,t.value,true)}}else{this.addKeyValue(e,t.name,t.value)}}else{if(t.nodeName==="OPTION"&&t.selected){const o=t.closest("select");if(o.hasChildNodes()){this.addKeyValue(e,o.name,t.value,true)}}}}}}async search4ElemTasks(t){if(t.hasChildNodes()){for(const e of t.childNodes){if(e.nodeName!=="TEMPLATE"&&e.nodeName!=="SCRIPT"&&e.nodeType!==e.TEXT_NODE&&e.nodeType!==e.COMMENT_NODE&&e.nodeType!==e.DOCUMENT_FRAGMENT_NODE){if(e.hasAttribute(this.tasksAttribute)){await this.setTask(e)}if(e.hasChildNodes()){await this.search4ElemTasks(e)}}}}}minifyJavaScript(t){return t.replace(/\/\/.*|\/\*[\s\S]*?\*\//g,"").replace(/\s+/g," ").trim()}reScript(t){for(const e of t.childNodes){if(e.hasChildNodes()){this.reScript(e)}if(e.nodeName==="SCRIPT"){const r=document.createElement("script");r.type="text/javascript";r.textContent=this.minifyJavaScript(e.textContent);e.replaceWith(r)}}}buildFragment(input,data,source){const helper=document.createElement("div");try{helper.insertAdjacentHTML("afterbegin",eval("`"+source+"`"))}catch(error){console.error(error)}this.reScript(helper);return helper}async fetchTemplate(t){try{const e=await fetch("./templates/".concat(t,".html"));if(!e.ok){throw new Error(`HTTP error! status: ${e.status} ${e.statusText}`)}return e.text()}catch(t){console.error(t)}return undefined}setTransformation(t,e){for(const[r,s]of Object.entries({target:"this",template:"",swap:"inner",after:"",before:""})){if(e.hasOwnProperty(r)){t[r]=e[r]}else if(s!==""&&!t.hasOwnProperty(r)){t[r]=s}}}async sequenceTasks(t,e,r){const s=r.target==="this"?e.currentTarget:document.querySelector(r.target);if(s===null){throw new Error(`Target "${propertyTarget}" not exist!`)}if(r.hasOwnProperty("before")&&r.before!==""){this.runSubtasks(e.currentTarget,r.before)}await this.search4ElemTasks(t);this.swapContent(t,s,r.hasOwnProperty("swap")?r.swap:"inner");if(r.hasOwnProperty("after")&&r.after!==""){this.runSubtasks(e.currentTarget,r.after)}}thisElement(t,e,r){const s=e.split(/\, */);let o=[];for(const a of s){if(a==="this"){if(t.hasAttribute("name")&&t.name!==""){r[t.name]=t.hasAttribute("value")?t.value:""}continue}o.push(a)}return o.join(",")}async templateManager(s,t,e){if(s.template.length<3){throw new Error(`Short template name "${s.template}"`)}const r=await(async t=>{switch(Array.from(s.template)[0]){case"@":return await t.fetchTemplate(s.template.substring(1));case"#":const e=document.getElementById(s.template.substring(1));if(e===null){throw new Error(`Template "${s.template}" not exist!`)}if(e.content.hasChildNodes()&&e.content.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&e.content.hasChildNodes){const r=document.createElement("textarea");r.insertAdjacentHTML("afterbegin",e.innerHTML);return r.value}throw new Error(`Invalid "${s.template}" embedded template`);default:throw new Error(`Invalid "${s.template}" fetched template`)}})(this);const o=this.buildFragment(t,e,r);if(o===null){throw new Error(`An error happened while processing the "${s.template}" template`)}return o}async setTemplateData(t,e){let r={};if(e.hasOwnProperty("collect-data")){const a=this.thisElement(t.currentTarget,e["collect-data"],r);if(a.length>0){const n=document.querySelectorAll(a);for(const i of n){this.collectBodyData(i,r)}}}const s=await(async t=>{if(e.hasOwnProperty("src-file")){return await t.getResource(e["src-file"])}return{}})(this);if(e.hasOwnProperty("function")){if(!this.custom_functions.hasOwnProperty(e["function"])){throw new Error(`The registered function "${e.function}" not exist!`)}this.custom_functions[e["function"]](t,r,s)}if(e.hasOwnProperty("template")&&e.hasOwnProperty("target")&&e.target!=""){const c=await this.templateManager(e,r,s);await this.sequenceTasks(c,t,e)}const o=e.target==="this"?t.currentTarget:document.querySelector(e.target);if(o!==null){this.swapContent(null,o,e.hasOwnProperty("swap")?e.swap:"inner")}}async processReqData(r,t){if(typeof r==="object"){console.log("json data from server...");if(t.hasOwnProperty("template")){const e=await this.templateManager(t,{},r);return e}throw new Error("There is no json data for the transformation")}if(typeof r==="string"&&r!==""){console.log("raw data from server...");const e=(t=>{const e=document.createElement("div");e.innerHTML=r;t.reScript(e);return e})(this);return e}throw new Error("There is no data for the transformation")}serialize(t){let e={};for(const[r,s]of t){if(e[r]!==undefined){if(!Array.isArray(e[r])){e[r]=[e[r]]}e[r].push(s)}else{e[r]=s}}return e}async prepareRequest(t,e){let r=undefined;if(e.hasOwnProperty("function")){if(!this.custom_functions.hasOwnProperty(e["function"])){throw new Error(`The registered function "${e.function}" not exist!`)}r=this.custom_functions[e["function"]](t);if(r===undefined){if(e.hasOwnProperty("next")){delete e.next}return}}else if(e.hasOwnProperty("trigger")&&e.trigger==="submit"){const a=t.currentTarget.closest("form");if(a!==null){const n=new FormData(a);r=e.method==="post"?n:this.serialize(n)}}const s=await this.makeRequest(e,r);if(s===undefined){return}if(e.hasOwnProperty("error")&&s.error){e=this.tasks[e["error"]];if(e.hasOwnProperty("message")){s.data=e["message"]}}this.setTransformation(e,s.transformation);const o=await this.processReqData(s.data,e);await this.sequenceTasks(o,t,e)}webSocketConnection(r,s){const e=new WebSocket(s.connect);e.addEventListener("open",async t=>{console.log("unimplemented!");e.send("Hello Server!")});e.addEventListener("message",async t=>{const e=await this.processReqData(t.data,s);await this.sequenceTasks(e,r,s)})}async processEvent(t,e){for(const r of Object.keys(e)){if(!r.startsWith("attribute-")){continue}const s=r.substring("attribute-".length);if(s.length>1&&t.currentTarget.hasAttribute(e[r])){e[s]=t.currentTarget.getAttribute(e[r])}}if(e.hasOwnProperty("then")&&e.then!==""){this.runSubtasks(t.currentTarget,e.then)}if(e.hasOwnProperty("connect")){if(e.connect===""){throw new Error("Empty connection")}this.webSocketConnection(t,e)}else if(e.hasOwnProperty("action")){if(e.action===""){throw new Error("Empty action")}if(e.hasOwnProperty("method")){e.method=e.method.toLowerCase();if(!this.methods.has(e.method)){throw new Error(`Unknown HTTP method: ${e.method}`)}}else{e["method"]="get"}await this.prepareRequest(t,e)}else{await this.setTemplateData(t,e)}if(e.hasOwnProperty("next")&&e.next!==""){await this.runNextTask(t,e.next)}}setDefaultTrigger(t){if(t.nodeName==="FORM"){return"submit"}if(t.nodeName==="BUTTON"){return t.type==="submit"?"submit":"click"}if(t.nodeName==="INPUT"&&t.type==="button"){return"click"}return null}async setTask(t){const e=t.dataset.tasks.split(/ +/);for(const r of e){if(!this.tasks.hasOwnProperty(r)){throw new Error(`The task "${r}" not exist in tasks file!`)}console.log("Task:",r);const s=structuredClone(this.tasks[r]);if(s.hasOwnProperty("attribute-trigger")&&t.hasAttribute(s["attribute-trigger"])&&t.getAttribute(s["attribute-trigger"])!==""){s["trigger"]=t.getAttribute(s["attribute-trigger"])}if(!s.hasOwnProperty("disabled")){s["disabled"]=false}if(!s.hasOwnProperty("prevent")){s["prevent"]=true}if(s.trigger==="init"){if(s.disabled===false){t.addEventListener("init",async t=>{if(s.prevent){t.preventDefault()}if(s.disabled===false){try{await this.processEvent(t,s)}catch(t){console.log(`Error for "${r}": ${t}`)}}});const o=new CustomEvent("init",{bubbles:true,cancelable:true});t.dispatchEvent(o)}continue}if(!(s.hasOwnProperty("trigger")&&this.triggers.has(s.trigger))){s.trigger=this.setDefaultTrigger(t);if(s.trigger===null){throw new Error(`No trigger defined for "${r}"!`)}}t.addEventListener(s.trigger,async t=>{if(s.prevent){t.preventDefault()}if(s.disabled===false){try{await this.processEvent(t,s)}catch(t){console.log(`Error for "${r}": ${t}`)}}})}}async getDataTasks(){const t=document.querySelectorAll("script[data-tasktable]");for(const e of t){if(e.type.toLowerCase()!=="application/json"){throw new Error(`Wrong mime-type "${e.type}" for element tasks!`)}if(e.hasAttribute("src")&&e.src!==""){const r=await(async t=>{return await t.getResource(e.src)})(this);Object.assign(this.tasks,r);continue}const r=JSON.parse(e.text);Object.assign(this.tasks,r)}}function_register(t,e){this.custom_functions[t]=e}init(){const t=document.getElementsByTagName(this.startElement);const e={childList:true,subtree:true};const r=(t,s)=>{t.forEach(t=>{if(t.type==="childList"){for(const e of t.addedNodes){console.log("Added Nodes...")}for(const r of t.removedNodes){console.log("Removed Nodes...")}if(t.target.childNodes.length===0){s.disconnect()}}})};const s=new MutationObserver(r);s.observe(t[0],e);this.getDataTasks().then(async()=>{if(Object.keys(this.tasks).length>=0){await this.search4ElemTasks(t[0])}})}}export{Secutio};